<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Äî –û–Ω–∫–æ–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">

  <div class="max-w-3xl mx-auto p-6 pt-12">
    <div class="text-center mb-10">
      <h1 class="text-5xl font-bold text-indigo-700">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ üëã</h1>
      <p class="text-2xl text-gray-600 mt-3">–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º –≤–∞—à –ø–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏</p>
    </div>

    <div id="uploadArea" class="bg-white rounded-3xl shadow-xl p-12 text-center border-2 border-dashed border-indigo-200 hover:border-indigo-400 transition cursor-pointer">
      <input type="file" id="fileInput" class="hidden">
      <div class="text-7xl mb-6">üìã</div>
      <p class="text-2xl font-medium">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –ø–ª–∞–Ω–æ–º –ª–µ—á–µ–Ω–∏—è</p>
      <button onclick="document.getElementById('fileInput').click()" 
              class="mt-8 px-10 py-4 bg-indigo-600 text-white text-xl rounded-3xl hover:bg-indigo-700">
        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
      </button>
    </div>

    <div id="loading" class="hidden text-center py-20">
      <div class="animate-spin w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto"></div>
      <p class="mt-8 text-2xl text-gray-600">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à –ø–ª–∞–Ω...</p>
    </div>

    <div id="result" class="hidden space-y-10">
      <div class="bg-white rounded-3xl shadow-xl p-10">
        <h2 class="text-3xl font-semibold text-emerald-700 flex items-center gap-3">
          <span>üìò</span> –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
        </h2>
        <div id="simpleExplanation" class="mt-6 text-xl text-gray-700 leading-relaxed"></div>
      </div>

      <div id="doctorBlock" class="bg-white rounded-3xl shadow-xl p-10 hidden">
        <h2 class="text-3xl font-semibold text-amber-700 flex items-center gap-3">
          <span>‚ùì</span> –ß—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å —É –≤—Ä–∞—á–∞
        </h2>
        <div id="questionsList" class="mt-8 space-y-6"></div>
      </div>
    </div>
  </div>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const loading = document.getElementById('loading');
    const resultDiv = document.getElementById('result');

    fileInput.addEventListener('change', e => {
      if (e.target.files[0]) handleFile(e.target.files[0]);
    });

    uploadArea.addEventListener('dragover', e => { 
      e.preventDefault(); 
      uploadArea.style.borderColor = '#4f46e5'; 
    });
    uploadArea.addEventListener('dragleave', () => uploadArea.style.borderColor = '#6366f1');
    uploadArea.addEventListener('drop', e => {
      e.preventDefault();
      uploadArea.style.borderColor = '#6366f1';
      if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });

    async function handleFile(file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('mode', 'patient');

      uploadArea.classList.add('hidden');
      loading.classList.remove('hidden');

      try {
        const res = await fetch('/analyze-file', { method: 'POST', body: formData });
        if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}`);

        const backendData = await res.json();
        console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', backendData);

        // –°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ: —Ä–∞—Å–ø–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É, –∫–æ—Ç–æ—Ä–∞—è –ª–µ–∂–∏—Ç –≤ .analysis
        let analysis = {};

        if (backendData.analysis) {
          try {
            // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –∏ –ø—Ä–æ–±–µ–ª—ã
            let cleaned = backendData.analysis.trim();
            // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∫–∞–≤—ã—á–∫–∞–º–∏ ‚Äî —É–±–∏—Ä–∞–µ–º –∏—Ö
            cleaned = cleaned.replace(/^["']/, '').replace(/["']$/, '');
            analysis = JSON.parse(cleaned);
          } catch (parseErr) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å analysis:', parseErr);
            analysis = { simple_explanation: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑." };
          }
        } else if (backendData.simple_explanation) {
          // –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ —á–∏—Å—Ç—ã–π –æ–±—ä–µ–∫—Ç
          analysis = backendData;
        }

        renderPatientView(analysis);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', err);
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      } finally {
        loading.classList.add('hidden');
      }
    }

    function renderPatientView(data) {
      resultDiv.classList.remove('hidden');

      // –ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
      const expl = data.simple_explanation || "–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω.";
      document.getElementById('simpleExplanation').innerHTML = expl;

      // –í–æ–ø—Ä–æ—Å—ã –≤—Ä–∞—á—É
      const qList = document.getElementById('questionsList');
      const doctorBlock = document.getElementById('doctorBlock');
      qList.innerHTML = '';

      const questions = data.questions_for_doctor || [];

      if (questions.length > 0) {
        doctorBlock.classList.remove('hidden');
        questions.forEach(q => {
          const div = document.createElement('div');
          div.className = 'border-l-4 border-amber-500 pl-6 py-3';
          div.innerHTML = `<p class="text-xl text-gray-800">${q}</p>`;
          qList.appendChild(div);
        });
      } else {
        doctorBlock.classList.add('hidden');
      }
    }
  </script>
</body>
</html>